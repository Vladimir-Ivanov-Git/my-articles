В данной статье мы расскажем про еще один способ осуществления **MiTM в WiFi сети**, не самый простой, но все же. Прежде чем читать эту статью настоятельно рекомендую ознакомиться с другой моей [статьей](https://habrahabr.ru/company/dsec/blog/333978/) в которой я попытался объяснить принцип работы протокола DHCP и как с его помощью атаковать клиентов.

В данной статье мы найдем еще один способ организовать MiTM в WiFi сети использующую технологию WPA2-PSK. Как и всегда есть пару ограничений:
1. Мы должны быть подключены к атакуемой точке доступа.
2. Мы можем прослушивать широковещательный траффик в сети.

И так как же это работает атака разделяется на несколько этапов:
1. Производим атаку DHCP Starvation
2. Отправляем WiFi DeAuth пакеты
3. Перехватываем DHCPREQUEST запросы от клиентов чтобы узнать transaction id, зная это значение отправляем широковещетельный DHCPDECLINE, представяясь в качетсве DHCP relay agent
4. Еще раз отправялем WiFi DeAuth пакеты
5. Profit!

Разберемся в этой схеме поподробнее.

## DHCP Starvation
Подключаемся к атакуемой WiFi сети и производим атаку DHCP Starvation с целью переполнить пул свободных IP адресов.
Как это работает:

1. Формируем и отправляем широковещательный DHCPDISCOVER-запрос, при этом представлемся как DHCP relay agent. В поле **giaddr** (Relay agent IP) указываем свой IP-адрес **192.168.1.2**, в поле **chaddr** (Client MAC address) - рандомный MAC **00:19:bb:f5:e7:a8**, при этом на канальном уровне в SRC MAC выставляем свой MAC-адрес.
![DHCPDISCOVER](https://habrastorage.org/web/0f1/7cf/1db/0f17cf1dbfb44b1e9e841a253711ec63.png)

2. Сервер отвечает сообщением DHCPOFFER агенту ретрансляции (нам), и предлагает клиенту с MAC-адресом **00:19:bb:f5:e7:a8** IP-адрес **192.168.1.232**
![DHCPOFFER](https://habrastorage.org/web/991/a1d/01f/991a1d01f08b4e2d8eb9201bdcc0ea01.png)

3. После получения DHCPOFFER, отправляем широковещательный DHCPREQUEST-запрос, при этом в DHCP-опции с кодом 50 ([Requested IP address](https://tools.ietf.org/html/rfc2132#section-9.1)) выставляем предложеный клиенту IP-адрес **192.168.1.232**, в опции с кодом 12 ([Host Name Option](https://tools.ietf.org/html/rfc2132#section-3.14)) - рандомную строку. **Важно:** значения полей **xid** (Transaction ID) и **chaddr** (Client MAC address) в DHCPREQUEST и DHCPDISCOVER должны быть одинаковыми, иначе сервер отбросит запрос, ведь это будет выглядеть, как другая транзакция от того же клиента, либо другой клиент с той же транзакцией.
![DHCPREQUEST](https://habrastorage.org/web/f64/9f9/f6a/f649f9f6a7e44936997b618f09bd5225.png)

4. Сервер отправляет агенту ретрансляции сообщение DHCPACK. С этого момента IP-адрес **192.168.1.232** считается зарезервированным за клиентом с MAC-адресом **00:19:bb:f5:e7:a8** на 12 часов (время аренды по умолчанию).
![DHCPACK](https://habrastorage.org/web/07d/cb9/341/07dcb93413d24665a7e3ca884a3ef6e7.png)

## WiFi DeAuth
Работает эта схема примерно так:
![WiFi DeAuth](https://upload.wikimedia.org/wikipedia/commons/9/95/Deauth_attack_sequence_diagram.svg)

Отправляем deauth пакеты с целью отсоединить клиентов WiFi сети от точки доступа:

## DHCPDECLINE
После того как клиенты отсоединись от точки доступа они заново подключаются к WiFi сети и пытаются получить IP-адрес по DHCP. Так как ранее они уже подключались этой сети то будут отравлять только широковещательный DHCPREQUEST, мы перехватываем их запросы и отправляем им DHCPACK, но ответить быстрее точки досупа мы естественно не успеем, но из перехваченного DHCPREQUEST мы узнаем transaction id, а зная его мы можем отправить DHCPDECLINE от имени клиента при этом мы выступаем в роли dhcp relay agent. Таким образом клиент получил DHCPACK от точки доступа и от нас, при этом точка ответила быстрее нас поэтому клиент выставляет соответствующие паратметры своему сетевому интерфейсу в соответвии с указанными в DHCPACK от точки доступа. Но мы отправли DHCPDECLINE поэтому точка доступа больше не может выдать этому клиенту тот же IP-адрес.

## WiFi DeAuth again
И так последний этап атаки отправляем еще одну порцию deauth пакетов, клиенты опять же отключаются от сети и при повторном подкоючении отправляют широковещателный DHCPREQUEST при этом в requested ip указывают IP-адрес присвоенный ранее но точка больше не может выдать этот IP так как был DHCPDECLINE и точка отправляет DHCPNAK что заставляет клиента пройти процедуру получения сетевых параметров с самого начала, а это значит клиент отправит DHCPDISCOVER. На этот запрос точка не сможет ответитить DHCPOFFER потому что пул IP адресов полностью заполнен, поэтому DHCPOFFER отправим только мы. Клиент получив DHCPOFFER только от нас отправляет DHCPREQUEST в этом случае точка доступа отправит DHCPNAK, а мы DHCPACK. Клиент принимает наш DHCPACK, а DHCPNAK от точки доступа просто проигнорирует. Таким образом мы можем выставлять любые сетевые параметры, а именнно шлюз по умолчанию, DNS сервер и т.д. любому подключенному или новому клиенту в атакуемой WiFi сети.
